<!DOCTYPE html>
<html>
<head>
    <title>Ops-Map Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="leaflet-0.7.7.css" />
    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #1C2833; overflow: hidden; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }

        /* THE MENU DRAWER */
        #drawer {
            position: absolute; top: 0; left: -285px; width: 270px; height: 100%;
            background: #1C2833; color: #D5DBDB; z-index: 20001;
            border-right: 4px solid #2E86C1; transition: 0.3s; -webkit-transition: 0.3s;
            overflow-y: auto;
        }
        #drawer.open { left: 0px; }

        /* THE "CLICK-OUTSIDE" OVERLAY */
        #overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 20000;
        }
        #overlay.active { display: block; }
        
        .menu-section { padding: 15px; border-bottom: 1px solid #2C3E50; }
        .menu-title { color: #5DADE2; font-size: 11px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .menu-btn { 
            display: block; width: 100%; margin-bottom: 8px; padding: 14px; 
            background: #273746; border: 1px solid #34495E; color: #FBFCFC; 
            text-align: left; font-size: 14px; cursor: pointer; touch-action: manipulation;
        }

        #menu-toggle {
            position: absolute; top: 15px; left: 15px; z-index: 15000;
            background: #28B463; color: #FFF; padding: 12px 18px; border: none; font-weight: bold;
        }
    </style>
</head>
<body>

    <button id="menu-toggle" onclick="toggleMenu()">‚â° MENU</button>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="drawer">
        <div class="menu-section">
            <div class="menu-title">Navigation</div>
            <button class="menu-btn" onclick="executeAction(getLocation)">üìç Locate Asset</button>
            <button class="menu-btn" onclick="executeAction(prepNav)">üõ§Ô∏è Vector Nav (A to B)</button>
        </div>
        <div class="menu-section">
            <div class="menu-title">Layers</div>
            <button class="menu-btn" onclick="executeAction(() => setLayer('std'))">Standard</button>
            <button class="menu-btn" onclick="executeAction(() => setLayer('sat'))">Satellite</button>
            <button class="menu-btn" onclick="executeAction(togglePOIs)">Toggle Data Layers</button>
        </div>
        <div class="menu-section">
            <div class="menu-title">Transmission</div>
            <button class="menu-btn" onclick="executeAction(() => document.getElementById('cam-input').click())">üì∏ Photo & Share</button>
            <button class="menu-btn" onclick="executeAction(shareLoc)">üì§ Transmit Coords</button>
            <input type="file" id="cam-input" accept="image/*" capture="camera" style="display:none" onchange="processPhoto(this)">
        </div>
        <button class="menu-btn" style="background:#C0392B; text-align:center;" onclick="toggleMenu()">CLOSE MENU</button>
    </div>

    <div id="map"></div>

    <script src="leaflet-0.7.7.js"></script>
    <script>
        var map = L.map('map', {zoomControl: false}).setView([1.49, 103.75], 13);
        var currentGPS = null;
        var navMode = false;
        var poiLayer = L.layerGroup();
        var navLine = null;

        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // UI CONTROL
        function toggleMenu() {
            document.getElementById('drawer').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        // Helper to close menu automatically after an action
        function executeAction(actionFunc) {
            actionFunc();
            toggleMenu(); 
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentGPS = L.latLng(position.coords.latitude, position.coords.longitude);
                    L.marker(currentGPS).addTo(map).bindPopup("Active Location").openPopup();
                    map.setView(currentGPS, 16);
                });
            }
        }

        function prepNav() {
            if (!currentGPS) { alert("Asset location missing."); return; }
            navMode = true;
            alert("Click destination on map.");
        }

        map.on('click', function(e) {
            if (navMode && currentGPS) {
                if (navLine) map.removeLayer(navLine);
                navLine = L.polyline([currentGPS, e.latlng], {color: '#00FFFF', dashArray: '10,15'}).addTo(map);
                map.fitBounds(navLine.getBounds());
                navMode = false;
            }
        });

        function shareLoc() {
            if (!currentGPS) return;
            var txt = "Location: " + currentGPS.lat.toFixed(5) + "," + currentGPS.lng.toFixed(5);
            window.location.href = "sms:?body=" + encodeURIComponent(txt);
        }

        function togglePOIs() {
            if (map.hasLayer(poiLayer)) map.removeLayer(poiLayer);
            else poiLayer.addTo(map);
        }
    </script>
</body>
</html>
