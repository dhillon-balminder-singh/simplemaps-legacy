<!DOCTYPE html>
<html>
<head>
    <title>Ops-Map Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="leaflet-0.7.7.css" />
    <style>
        /* NAVY PROFESSIONAL THEME */
        html, body { height: 100%; margin: 0; padding: 0; background: #1C2833; overflow: hidden; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; background: #1C2833; }

        #drawer {
            position: absolute; top: 0; left: -280px; width: 270px; height: 100%;
            background: #1C2833; color: #D5DBDB; z-index: 9999;
            border-right: 4px solid #2E86C1; transition: left 0.3s; -webkit-transition: left 0.3s;
        }
        #drawer.open { left: 0px; }
        
        .menu-section { padding: 20px 15px; border-bottom: 1px solid #2C3E50; }
        .menu-title { color: #5DADE2; font-size: 11px; font-weight: bold; margin-bottom: 12px; text-transform: uppercase; }
        .menu-btn { 
            display: block; width: 100%; margin-bottom: 10px; padding: 14px; 
            background: #273746; border: 1px solid #34495E; color: #FBFCFC; text-align: left;
        }

        #menu-toggle {
            position: absolute; top: 15px; left: 15px; z-index: 9000;
            background: #28B463; color: #FFF; padding: 12px 18px; border: none; font-weight: bold;
        }
        #cam-input { display: none; }
    </style>
</head>
<body>
    <button id="menu-toggle" onclick="toggleMenu()">‚â° SYSTEM MENU</button>

    <div id="drawer">
        <div class="menu-section">
            <div class="menu-title">Deployment</div>
            <button class="menu-btn" onclick="getLocation()">üìç Locate Asset</button>
            <button class="menu-btn" onclick="prepNav()">üõ§Ô∏è Vector Nav (A to B)</button>
        </div>
        <div class="menu-section">
            <div class="menu-title">View</div>
            <button class="menu-btn" onclick="togglePOIs()">Toggle Data Layers</button>
        </div>
        <div class="menu-section">
            <div class="menu-title">Transmission</div>
            <button class="menu-btn" onclick="document.getElementById('cam-input').click()">üì∏ Capture Visual</button>
            <input type="file" id="cam-input" accept="image/*" capture="camera" onchange="processPhoto(this)">
        </div>
    </div>

    <div id="map"></div>

    <script src="leaflet-0.7.7.js"></script>
    <script>
        var map = L.map('map', {zoomControl: false}).setView([1.49, 103.75], 13);
        var currentGPS = null;
        var navMode = false;
        var poiLayer = L.layerGroup();
        var navLine = null;
        var destinationMarker = null;

        // Base Layer
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 1. DATABASE LOGIC
        var db = window.openDatabase("MapDB", "1.0", "Offline Maps", 20 * 1024 * 1024);
        db.transaction(function(tx) {
            tx.executeSql('SELECT content FROM maps WHERE id = "active_map"', [], function (tx, results) {
                if (results.rows.length > 0) {
                    renderVectorMap(JSON.parse(results.rows.item(0).content));
                }
            });
        });

        function renderVectorMap(geoData) {
            L.geoJson(geoData, {
                style: function() { return { color: "#2E86C1", weight: 2 }; }
            }).addTo(poiLayer);
        }

        // 2. CORE FUNCTIONS
        function toggleMenu() {
            var d = document.getElementById('drawer');
            d.className = (d.className === 'open') ? '' : 'open';
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    currentGPS = L.latLng(position.coords.latitude, position.coords.longitude);
                    L.marker(currentGPS).addTo(map).bindPopup("Asset Located").openPopup();
                    map.setView(currentGPS, 15);
                    toggleMenu();
                }, null, { enableHighAccuracy: true });
            }
        }

        function prepNav() {
            navMode = true;
            toggleMenu();
            alert("Tap destination on map.");
        }

        map.on('click', function(e) {
            if (navMode && currentGPS) {
                if (navLine) map.removeLayer(navLine);
                navLine = L.polyline([currentGPS, e.latlng], {color: '#00FFFF', dashArray: '10,10'}).addTo(map);
                navMode = false;
            }
        });

        function togglePOIs() {
            if (map.hasLayer(poiLayer)) map.removeLayer(poiLayer);
            else poiLayer.addTo(map);
            toggleMenu();
        }
    </script>
</body>
</html>
